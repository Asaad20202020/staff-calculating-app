import streamlit as st
import pandas as pd
import io # Ù…ÙƒØªØ¨Ø© Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„Ù…Ù„ÙØ§Øª ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©

# --- 1. Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØµÙØ­Ø© ---
st.set_page_config(page_title="Ù†Ø¸Ø§Ù… ØªÙˆØ²ÙŠØ¹ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ", layout="wide")
st.title("ğŸš€ Ù†Ø¸Ø§Ù… Ø§Ø­ØªØ³Ø§Ø¨ ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§")

# --- 2. ÙˆØ§Ø¬Ù‡Ø© Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª ---
st.header("Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø§Ø±ÙØ¹ Ù…Ù„ÙØ§Øª Ø§Ù„Ø¥ÙƒØ³Ù„ (CSV)")

# ÙˆØ¶Ø¹ 3 Ø£Ø¹Ù…Ø¯Ø© Ù„Ø±ÙØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
col1, col2, col3 = st.columns(3)

with col1:
    file_employees = st.file_uploader("1. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ù…ÙˆØ¸ÙÙŠÙ† (employees.csv)", type="csv")

with col2:
    file_allocations = st.file_uploader("2. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹ (allocations.csv)", type="csv")

with col3:
    file_attendance = st.file_uploader("3. Ø§Ø±ÙØ¹ Ù…Ù„Ù Ø§Ù„Ø­Ø¶ÙˆØ± (attendance.csv)", type="csv")


# --- 3. Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© ÙˆØ§Ù„ØªØ´ØºÙŠÙ„ ---
st.header("Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ´ØºÙŠÙ„ Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª")

if st.button("Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ø¨Ø¯Ø¡ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ"):
    
    # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª
    if file_employees is not None and file_allocations is not None and file_attendance is not None:
        
        try:
            with st.spinner("...Ø¬Ø§Ø±Ù Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„ÙØ§Øª..."):
                # --- Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ù…Ù„ÙØ§Øª ---
                df_employees = pd.read_csv(file_employees)
                df_employees = df_employees[['employee_id', 'Name', 'pay_type', 'daily_rate']]
                
                df_attendance = pd.read_csv(file_attendance)
                df_attendance = df_attendance.dropna(subset=['employee_id'])
                df_attendance = df_attendance[['employee_id', 'worked_days']]
                df_attendance['employee_id'] = df_attendance['employee_id'].astype(int)

                # --- Ù…Ø¹Ø§Ù„Ø¬Ø© Ù…Ù„Ù Ø§Ù„ØªÙˆØ²ÙŠØ¹ (Allocations) ---
                df_allocations_raw = pd.read_csv(file_allocations, header=1)
                df_allocations = df_allocations_raw.melt(
                    id_vars=['employee_id', 'Name'], 
                    var_name='Project_Code', 
                    value_name='Allocation_Percentage'
                )
                df_allocations = df_allocations.dropna(subset=['Allocation_Percentage'])
                df_allocations['Allocation_Percentage'] = pd.to_numeric(df_allocations['Allocation_Percentage'], errors='coerce')
                df_allocations = df_allocations.dropna(subset=['Allocation_Percentage'])
                df_allocations = df_allocations[['employee_id', 'Project_Code', 'Allocation_Percentage']]

            st.success("âœ… ØªÙ… Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø¨Ù†Ø¬Ø§Ø­.")

            # --- 3. Ø¯Ù…Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ---
            with st.spinner("...Ø¬Ø§Ø±Ù Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ ÙˆØªÙˆØ²ÙŠØ¹Ù‡Ø§..."):
                df_main = pd.merge(df_employees, df_attendance, on='employee_id', how='left')
                df_main['worked_days'] = df_main['worked_days'].fillna(0)
                df_main['Total_Cost'] = df_main['daily_rate'] * df_main['worked_days']

                # --- 4. Ø¯Ù…Ø¬ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ù…Ø¹ Ù†Ø³Ø¨ Ø§Ù„ØªÙˆØ²ÙŠØ¹ ---
                df_final = pd.merge(df_main, df_allocations, on='employee_id', how='inner')
                df_final['Cost_For_Project'] = df_final['Total_Cost'] * df_final['Allocation_Percentage']

            st.success("âœ… ØªÙ… Ø§Ø­ØªØ³Ø§Ø¨ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø§Ù„Ù…ÙˆØ²Ø¹Ø©.")
            
            # --- 5. Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ---
            with st.spinner("...Ø¬Ø§Ø±Ù Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ©..."):
                report_detailed = df_final[[
                    'employee_id', 'Name', 'Project_Code', 'daily_rate', 
                    'worked_days', 'Total_Cost', 'Allocation_Percentage', 'Cost_For_Project'
                ]].sort_values(by=['Name', 'Project_Code'])

                report_summary_project = df_final.groupby('Project_Code')['Cost_For_Project'].sum().reset_index()
                report_summary_project = report_summary_project.rename(columns={'Cost_For_Project': 'Total_Cost_For_Project'})

                report_summary_employee = df_final.groupby(['employee_id', 'Name'])['Total_Cost'].first().reset_index()

            st.success("âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ±.")

            # --- 6. Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ ---
            st.header("Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ ÙˆØªØ­Ù…ÙŠÙ„Ù‡Ø§")
            
            # --- Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù„Ù Excel ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø© ---
            output_buffer = io.BytesIO()
            with pd.ExcelWriter(output_buffer, engine='openpyxl') as writer:
                report_detailed.to_excel(writer, sheet_name='Detailed_Report', index=False)
                report_summary_project.to_excel(writer, sheet_name='Summary_By_Project', index=False)
                report_summary_employee.to_excel(writer, sheet_name='Summary_By_Employee', index=False)
            
            # --- Ø²Ø± Ø§Ù„ØªÙ†Ø²ÙŠÙ„ ---
            st.download_button(
                label="ğŸ“¥ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ÙƒØ§Ù…Ù„ (Ù…Ù„Ù Excel)",
                data=output_buffer.getvalue(), # .getvalue() Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù€ buffer
                file_name="Cost_Allocation_Report.xlsx",
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )

            # --- Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙÙŠ Ø§Ù„ØµÙØ­Ø© ---
            st.subheader("Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø´Ø±ÙˆØ¹")
            st.dataframe(report_summary_project)

            st.subheader("Ù…Ù„Ø®Øµ Ø§Ù„ØªÙƒØ§Ù„ÙŠÙ Ø­Ø³Ø¨ Ø§Ù„Ù…ÙˆØ¸Ù")
            st.dataframe(report_summary_employee)

            st.subheader("Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„ØªÙØµÙŠÙ„ÙŠ (Ø£ÙˆÙ„ 100 ØµÙ)")
            st.dataframe(report_detailed.head(100))

        except FileNotFoundError as e:
            st.error(f"âŒ Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù„Ù. {e}")
        except Exception as e:
            st.error(f"âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹: {e}")
            st.exception(e) # Ù„Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø®Ø·Ø£
    
    else:
        st.error("âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±ÙØ¹ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ù„Ø§Ø«Ø© Ø£ÙˆÙ„Ø§Ù‹.")